<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìä Classement - Les P√¢t√©s Lorrains</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #1e1f22;
      color: white;
      margin: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      display: flex;
      gap: 2rem;
      width: 100%;
      max-width: 1200px;
    }
    .form, .preview {
      flex: 1;
      background: #2f3136;
      padding: 20px;
      border-radius: 12px;
      overflow-y: auto;
      max-height: 90vh;
    }
    input, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px;
      border-radius: 6px;
      border: none;
      background: #40444b;
      color: white;
      font-size: 1rem;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    button {
      background: #5865f2;
      cursor: pointer;
    }

    .embed-preview {
      display: flex;
      border-radius: 4px;
      background-color: #2f3136;
      border: 1px solid #202225;
      margin-bottom: 1rem;
      overflow: hidden;
      max-width: 600px;
    }
    .embed-color-bar {
      width: 4px;
      border-top-left-radius: 4px;
      border-bottom-left-radius: 4px;
      background-color: #00b0f4;
    }
    .embed-content {
      color: #dcddde;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      padding: 1rem;
      width: 100%;
    }
    .embed-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .embed-description {
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      white-space: pre-wrap;
    }
    .embed-footer {
      font-size: 0.75rem;
      color: #72767d;
      margin-top: 0.5rem;
    }
    .embed-image {
      margin-top: 1rem;
      border-radius: 4px;
      width: 100%;
      height: auto;
      display: block;
    }

    /* Modal gallery */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #2f3136;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-content::-webkit-scrollbar {
      width: 8px;
    }
    .modal-content::-webkit-scrollbar-track {
      background: #202225;
    }
    .modal-content::-webkit-scrollbar-thumb {
      background: #5865f2;
      border-radius: 4px;
    }

    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      color: white;
      cursor: pointer;
    }

    .imgbb-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }

    .imgbb-gallery img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .imgbb-gallery img:hover {
      border-color: #5865f2;
    }
  </style>
</head>
<body>
  <h1>üìä Classement - Les P√¢t√©s Lorrains</h1>
  <div class="container">
    <div class="form">
      <label for="webhook">Webhook Discord</label>
      <input type="text" id="webhook" placeholder="https://discord.com/api/webhooks/..." oninput="updateEmbed()" />

      <label for="username">Nom du bot</label>
      <input type="text" id="username" placeholder="Classement Bot" oninput="updateEmbed()" />

      <label for="title">Titre de l'embed</label>
      <input type="text" id="title" placeholder="üìä Classement - Les P√¢t√©s Lorrains" oninput="updateEmbed()" />

      <label for="ranking-text">Texte du classement</label>
      <textarea id="ranking-text" rows="6" placeholder="1. Minou\n2. Paul\n3. Jean..." oninput="updateEmbed()"></textarea>

      <label for="ranking-image">Lien de l'image (facultatif)</label>
      <input type="text" id="ranking-image" placeholder="https://..." oninput="updateEmbed()" />

      <label for="image-upload">Ou charge une image depuis ton PC</label>
      <input type="file" id="image-upload" accept="image/*" onchange="uploadImage(event)" />

      <label for="imgbb-api-key">Cl√© API ImgBB</label>
      <input type="text" id="imgbb-api-key" placeholder="Entre ta cl√© API ImgBB" oninput="saveAPIKey()" />

      <button onclick="showGallery()">üñºÔ∏è Galerie</button>

      <label for="mention-users">Mentions membres (IDs s√©par√©s par des virgules)</label>
      <input type="text" id="mention-users" placeholder="1234567890,0987654321" oninput="updateEmbed()" />

      <label for="mention-roles">Mentions r√¥les (IDs s√©par√©s par des virgules)</label>
      <input type="text" id="mention-roles" placeholder="1122334455,5566778899" oninput="updateEmbed()" />

      <button onclick="sendEmbed()">üì§ Envoyer sur Discord</button>
      <button onclick="saveJSON()">üíæ Enregistrer JSON</button>
      <input type="file" accept=".json" onchange="loadJSON(event)" />
    </div>

    <div class="preview">
      <h2>Aper√ßu de l'embed</h2>
      <div id="mentions-preview"></div>
      <div id="preview-area"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="gallery-modal">
    <div class="modal-content">
      <span class="close-button" onclick="hideGallery()">√ó</span>
      <h3>üñºÔ∏è Galerie ImgBB</h3>
      <div class="imgbb-gallery" id="imgbb-gallery"></div>
    </div>
  </div>

  <script>
    let embed = {
      title: "üìä Classement - Les P√¢t√©s Lorrains",
      description: "",
      color: 0x00b0f4,
      image: { url: "" },
      footer: { text: "" }
    };
    let currentWebhook = "";
    let currentUsername = "";
    let mentionUsers = [];
    let mentionRoles = [];

    function getFrenchDateTime() {
      return new Date().toLocaleString('fr-FR');
    }

    function updateEmbed() {
      embed.title = document.getElementById("title").value;
      embed.description = document.getElementById("ranking-text").value;
      embed.image.url = document.getElementById("ranking-image").value;
      embed.footer.text = getFrenchDateTime();
      currentWebhook = document.getElementById("webhook").value;
      currentUsername = document.getElementById("username").value;
      mentionUsers = document.getElementById("mention-users").value.split(",").map(id => id.trim()).filter(Boolean);
      mentionRoles = document.getElementById("mention-roles").value.split(",").map(id => id.trim()).filter(Boolean);
      renderPreview();
    }

    function renderPreview() {
      const preview = document.getElementById("preview-area");
      const mentionsDiv = document.getElementById("mentions-preview");
      preview.innerHTML = "";
      mentionsDiv.innerHTML = "";

      const wrapper = document.createElement("div");
      wrapper.className = "embed-preview";

      const colorBar = document.createElement("div");
      colorBar.className = "embed-color-bar";

      const content = document.createElement("div");
      content.className = "embed-content";
      content.innerHTML = `
        <div class="embed-title">${embed.title}</div>
        <div class="embed-description">${embed.description}</div>
        ${embed.image.url ? `<img class="embed-image" src="${embed.image.url}" />` : ''}
        <div class="embed-footer">${embed.footer.text}</div>
      `;

      const combinedMentions = [
        ...mentionUsers.map(id => `<@${id}>`),
        ...mentionRoles.map(id => `<@&${id}>`)
      ];
      if (combinedMentions.length) {
        mentionsDiv.innerHTML = "Mentions : " + combinedMentions.join(" ");
      }

      wrapper.appendChild(colorBar);
      wrapper.appendChild(content);
      preview.appendChild(wrapper);
    }

    async function sendEmbed() {
      if (!currentWebhook) return alert("Veuillez entrer un webhook Discord valide.");
      embed.footer.text = getFrenchDateTime();

      const content = [
        ...mentionUsers.map(id => `<@${id}>`),
        ...mentionRoles.map(id => `<@&${id}>`)
      ].join(" ");

      const response = await fetch(currentWebhook, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: currentUsername || "Classement Bot",
          content: content,
          embeds: [embed]
        })
      });

      alert(response.ok ? "‚úÖ Envoy√© avec succ√®s !" : "‚ùå Erreur lors de l'envoi.");
    }

    function saveJSON() {
      const data = {
        webhook: currentWebhook,
        username: currentUsername,
        title: embed.title,
        description: embed.description,
        image: embed.image.url,
        mentions_users: mentionUsers,
        mentions_roles: mentionRoles,
        imgbb_api_key: localStorage.getItem("imgbb_api_key") || ""
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "embed_config.json";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function loadJSON(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = JSON.parse(e.target.result);
        document.getElementById("webhook").value = data.webhook || "";
        document.getElementById("username").value = data.username || "";
        document.getElementById("title").value = data.title || "";
        document.getElementById("ranking-text").value = data.description || "";
        document.getElementById("ranking-image").value = data.image || "";
        document.getElementById("mention-users").value = (data.mentions_users || []).join(",");
        document.getElementById("mention-roles").value = (data.mentions_roles || []).join(",");
        if (data.imgbb_api_key) {
          localStorage.setItem("imgbb_api_key", data.imgbb_api_key);
          document.getElementById("imgbb-api-key").value = data.imgbb_api_key;
        }
        updateEmbed();
      };
      reader.readAsText(file);
    }

    function saveAPIKey() {
      const key = document.getElementById("imgbb-api-key").value.trim();
      localStorage.setItem("imgbb_api_key", key);
    }

    async function uploadImage(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function () {
        const base64Image = reader.result.split(',')[1];
        const formData = new FormData();
        formData.append('image', base64Image);
        const apiKey = localStorage.getItem("imgbb_api_key");
        if (!apiKey) {
          alert("‚ùå Cl√© API ImgBB manquante.");
          return;
        }

        try {
          const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
            method: 'POST',
            body: formData
          });

          const data = await response.json();
          if (data.success) {
            const imageUrl = data.data.url;
            document.getElementById('ranking-image').value = imageUrl;
            updateEmbed();
            saveImageToGallery(imageUrl);
            alert("‚úÖ Image h√©berg√©e avec succ√®s !");
          } else {
            alert("‚ùå Erreur lors de l'upload.");
          }
        } catch (error) {
          console.error(error);
          alert("‚ùå Erreur r√©seau ou imgbb indisponible.");
        }
      };

      reader.readAsDataURL(file);
    }

    function saveImageToGallery(url) {
      const stored = JSON.parse(localStorage.getItem("imgbb_gallery") || "[]");
      if (!stored.includes(url)) {
        stored.push(url);
        localStorage.setItem("imgbb_gallery", JSON.stringify(stored));
        renderGallery();
      }
    }

    function renderGallery() {
      const gallery = document.getElementById("imgbb-gallery");
      gallery.innerHTML = "";
      const images = JSON.parse(localStorage.getItem("imgbb_gallery") || "[]");

      images.forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        img.title = "Cliquer pour ins√©rer";
        img.onclick = () => {
          document.getElementById("ranking-image").value = url;
          updateEmbed();
          hideGallery();
        };
        gallery.appendChild(img);
      });
    }

    function showGallery() {
      document.getElementById("gallery-modal").style.display = "flex";
      renderGallery();
    }

    function hideGallery() {
      document.getElementById("gallery-modal").style.display = "none";
    }

    // Initialisation
    if (localStorage.getItem("imgbb_api_key")) {
      document.getElementById("imgbb-api-key").value = localStorage.getItem("imgbb_api_key");
    }
    updateEmbed();
  </script>
</body>
</html>
